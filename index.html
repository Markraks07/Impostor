<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Impostor Gamberro PRO â€“ Online con Supabase Realtime</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:radial-gradient(circle at top,#1e293b,#020617);color:#fff}
.app{max-width:1000px;margin:auto;padding:15px}
h1{text-align:center}
.hidden{display:none}
.card{background:#020617;border:1px solid #1e293b;border-radius:16px;padding:15px;margin-top:10px}
input,button{padding:10px;border-radius:10px;border:none;font-size:16px}
button{cursor:pointer;font-weight:bold}
.green{background:#22c55e}
.red{background:#ef4444}
.blue{background:#3b82f6}
.chat{height:260px;overflow-y:auto;background:#020617;border:1px solid #1e293b;border-radius:12px;padding:10px}
.msg{margin-bottom:6px}
.system{color:#facc15;font-style:italic}
.turn{color:#38bdf8}
.vote button{width:100%;margin-top:6px}
</style>
</head>
<body>
<div class="app">
<h1>ðŸ˜ˆ Impostor Gamberro PRO â€“ Supabase Realtime</h1>

<div id="join" class="card">
<input id="name" placeholder="Tu nombre o apodo ðŸ˜">
<input id="room" placeholder="CÃ³digo de sala">
<button class="green" onclick="joinRoom()">Entrar</button>
<p style="opacity:.6">Funciona para amigos y clase Â· Gratis</p>
</div>

<div id="role" class="card hidden">
<h3 id="roleText"></h3>
<p id="secret" style="font-size:22px"></p>
<button class="blue" onclick="goGame()">Entrar a la ronda</button>
</div>

<div id="game" class="card hidden">
<p id="turnInfo" class="turn"></p>
<div id="chat" class="chat"></div>
<div style="display:flex;gap:8px;margin-top:8px">
<input id="msg" placeholder="UNA palabra o frase corta">
<button class="green" onclick="sendMsg()">Enviar</button>
</div>
<button class="red" style="margin-top:10px" onclick="startVote()">ðŸ—³ VOTAR</button>
</div>

<div id="vote" class="card hidden">
<h3>ðŸ—³ Â¿QuiÃ©n es el impostor?</h3>
<div id="voteList" class="vote"></div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
const supabaseUrl = 'https://nrxrtpoaldkwyoeurmuv.supabase.co';
const supabaseKey = 'sb_publishable_TQgaNlToAmGmrNCi4ACcAA_3CP6bByO';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

const WORDS=[
{w:"Fiesta",h:"Alcohol y mÃºsica"},
{w:"Profesor",h:"Odia este juego"},
{w:"Suspender",h:"Miedo estudiantil"},
{w:"BotellÃ³n",h:"Juventud espaÃ±ola"},
{w:"Examen",h:"Pesadilla"}
];

let me={}, roomCode='';

async function joinRoom(){
  const n = document.getElementById('name').value.trim();
  roomCode = document.getElementById('room').value.trim();
  if(!n || !roomCode) return alert('Nombre y sala obligatorios');

  me.name = n;
  me.id = Date.now() + Math.random();

  // Crear sala si no existe
  let { data: room } = await supabase.from('rooms').select('*').eq('code', roomCode).single();
  if(!room){
    const sel = WORDS[Math.floor(Math.random()*WORDS.length)];
    await supabase.from('rooms').insert([{code: roomCode, word: sel.w, hint: sel.h, impostor: me.id, turn: me.id}]);
  }

  // Insertar jugador
  await supabase.from('players').insert([{name: me.name, room: roomCode, id: me.id, role: 'pending'}]);

  // Asignar rol si es primer jugador (simplificado)
  const { data: players } = await supabase.from('players').select('*').eq('room', roomCode);
  const isImp = players.length === 1;
  await supabase.from('players').update({role: isImp?'impostor':'legal'}).eq('id', me.id);

  showRole(isImp);
  setupRealtime();
}

async function showRole(isImp){
  document.getElementById('join').classList.add('hidden');
  document.getElementById('role').classList.remove('hidden');
  document.getElementById('roleText').innerText = isImp ? 'ðŸ˜ˆ ERES EL IMPOSTOR' : 'ðŸ˜‡ ERES LEGAL';
  const { data: room } = await supabase.from('rooms').select('*').eq('code', roomCode).single();
  document.getElementById('secret').innerText = isImp ? 'PISTA: '+room.hint : room.word;
}

function goGame(){
  document.getElementById('role').classList.add('hidden');
  document.getElementById('game').classList.remove('hidden');
}

function setupRealtime(){
  supabase.channel('room_'+roomCode)
    .on('postgres_changes', { event: '*', schema: 'public', table: 'chat', filter: `room=eq.${roomCode}` }, payload => {
      const d = document.createElement('div');
      d.className='msg';
      d.innerHTML='<b>'+payload.new.name+':</b> '+payload.new.text;
      const chat = document.getElementById('chat');
      chat.appendChild(d);
      chat.scrollTop = 9999;
    })
    .subscribe();
}

async function sendMsg(){
  const t = document.getElementById('msg').value.trim();
  if(!t) return;
  await supabase.from('chat').insert([{room: roomCode, name: me.name, text: t}]);
  document.getElementById('msg').value='';
}

async function startVote(){
  alert('VotaciÃ³n iniciada (implementar lÃ³gica completa en Supabase)');
}
</script>
</body>
</html>